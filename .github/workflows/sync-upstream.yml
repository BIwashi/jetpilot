name: Sync Upstream

on:
  workflow_dispatch:
  schedule:
    # Run daily at 00:00 UTC
    - cron: '0 0 * * *'

permissions:
  contents: write
  pull-requests: write

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: false

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Add upstream remote and fetch and fetch
        run: |
          git remote add upstream https://github.com/commaai/openpilot.git || true
          git fetch upstream master
          git fetch origin master

      - name: Check if sync is needed
        id: check
        run: |
          MERGE_BASE=$(git merge-base origin/master upstream/master)
          UPSTREAM_HEAD=$(git rev-parse upstream/master)

          echo "merge_base=$MERGE_BASE"
          echo "upstream_head=$UPSTREAM_HEAD"

          if [ "$MERGE_BASE" = "$UPSTREAM_HEAD" ]; then
            echo "Already up to date with upstream"
            echo "needs_sync=false" >> $GITHUB_OUTPUT
          else
            echo "Upstream has new commits"
            echo "needs_sync=true" >> $GITHUB_OUTPUT
            COMMITS_BEHIND=$(git rev-list --count origin/master..upstream/master)
            echo "commits_behind=$COMMITS_BEHIND" >> $GITHUB_OUTPUT
          fi

      - name: Attempt rebase onto upstream
      - name: Attempt rebase onto upstream
        if: steps.check.outputs.needs_sync == 'true'
        id: rebase
        run: |
          git checkout -B sync/upstream-master origin/master

          # Try rebase
          if git rebase upstream/master 2>&1; then
            echo "Rebase successful"
            echo "rebase_success=true" >> $GITHUB_OUTPUT
          else
            echo "Rebase failed due to conflicts"
            echo "rebase_success=false" >> $GITHUB_OUTPUT
            git rebase --abort || true

            # Reset and try merge to detect conflicts
            git checkout -B sync/upstream-master origin/master

            # Attempt merge and capture conflict info before aborting
            if ! git merge upstream/master --no-edit 2>&1; then
              # Get list of conflicting files while in conflict state
              CONFLICTS=$(git status --porcelain | grep -E "^(U|AA|DD)" | awk '{print $2}' | head -20)
              if [ -z "$CONFLICTS" ]; then
                # Fallback: check for submodule conflicts
                CONFLICTS=$(git status | grep -E "both modified|deleted by" | awk '{print $NF}' | head -20)
              fi
              echo "conflicts<<EOF" >> $GITHUB_OUTPUT
              echo "$CONFLICTS" >> $GITHUB_OUTPUT
              echo "EOF" >> $GITHUB_OUTPUT

              # Abort the failed merge
              git merge --abort || true
            fi

            # For conflict case: merge with accepting upstream changes for submodules
            # This creates a mergeable PR that shows the sync is needed
            git checkout -B sync/upstream-master origin/master
            git merge upstream/master -X theirs --no-edit || {
              # If still failing, force accept all upstream changes
              git checkout --theirs . 2>/dev/null || true
              git add -A
              git commit -m "Merge upstream/master (automated sync)" || true
            }
          fi

      - name: Create Pull Request
      - name: Create Pull Request
        if: steps.check.outputs.needs_sync == 'true'
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: sync/upstream-master
          base: master
          title: "${{ steps.rebase.outputs.rebase_success == 'true' && 'Sync with upstream (commaai/openpilot)' || '[CONFLICTS] Sync with upstream (commaai/openpilot)' }}"
          body: |
            ## Upstream Sync
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: sync/upstream-master
          base: master
          title: "${{ steps.rebase.outputs.rebase_success == 'true' && 'Sync with upstream (commaai/openpilot)' || '[CONFLICTS] Sync with upstream (commaai/openpilot)' }}"
          body: |
            ## Upstream Sync

            This PR syncs with the latest changes from [commaai/openpilot](https://github.com/commaai/openpilot) master branch.
            This PR syncs with the latest changes from [commaai/openpilot](https://github.com/commaai/openpilot) master branch.

            - **Commits behind upstream**: ${{ steps.check.outputs.commits_behind }}
            - **Rebase status**: ${{ steps.rebase.outputs.rebase_success == 'true' && 'Success' || 'Failed (conflicts detected)' }}

            ${{ steps.rebase.outputs.rebase_success != 'true' && format('### ⚠️ Action Required

            Automatic rebase failed due to conflicts. This PR was created with upstream changes merged using `-X theirs` strategy.

            **Please review carefully before merging**, or resolve manually:
            1. Check out this branch locally
            2. Run `git fetch upstream && git rebase upstream/master`
            3. Resolve conflicts manually
            4. Force push the resolved branch

            ### Conflicting files detected
            ```
            {0}
            ```', steps.rebase.outputs.conflicts) || '' }}

            ---
            *This PR was automatically created by GitHub Actions.*
          labels: |
            automated
            upstream-sync
